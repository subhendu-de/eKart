trigger:
  branches:
    include:
      - '*'

variables:
  buildConfiguration: 'Release'
  dotnetSdkVersion: '5.0.301'

stages:
 - stage: 'Build'
   jobs:
    - job:
      displayName: 'Build the application'
      pool:
        vmImage: 'windows-latest'
      steps:
        - task: UseDotNet@2
          displayName: 'Use .NET Core SDK $(dotnetSdkVersion)'
          inputs:
            version: '$(dotnetSdkVersion)'

        - task: NuGetToolInstaller@1
          displayName: 'Use nuget'

        - task: DotNetCoreCLI@2
          displayName: 'Restore project dependencies'
          inputs:
            command: 'restore'
            projects: '**/*.csproj'

        - task: DotNetCoreCLI@2
          displayName: 'Build the project - Release'
          inputs:
            command: 'build'
            arguments: '--no-restore --configuration $(buildConfiguration)'
            projects: '**/*.csproj'

        - task: CopyFiles@2
          displayName: 'Copy the files'
          inputs:
            SourceFolder: '$(Build.SourcesDirectory)/scripts'
            CleanTargetFolder: true
            TargetFolder: $(Build.DefaultWorkingDirectory)

 - stage: 'Provision' 
   jobs:
    - job:
      displayName: 'Create Azure resources'
      pool:
        vmImage: 'windows-latest'
      steps:
        - task: AzureResourceManagerTemplateDeployment@3
          inputs:
            deploymentScope: 'Subscription'
            azureResourceManagerConnection: 'Visual Studio Ultimate with MSDN'
            location: 'Central India'
            templateLocation: 'Linked artifact'
            csmFile: '$(Build.DefaultWorkingDirectory)/scripts/azuredeploy.json'
            deploymentMode: 'Incremental'

